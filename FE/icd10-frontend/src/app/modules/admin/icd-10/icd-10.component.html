<div class="grid grid-cols-1 sm:grid-cols-2 sm:h-[calc(100vh-120px)]">

    <!-- LEFT: Tree -->
    <div class="w-full border-r p-4 relative">
        <div *ngIf="isExpandingTree" 
            class="absolute inset-0 bg-white bg-opacity-80 z-50 flex flex-col items-center justify-center">
            <img src="assets/images/logo/loading.gif" alt="Loading..." class="h-1/2">
            <p class="mt-3 text-gray-600 font-medium">ƒêang m·ªü r·ªông c√¢y ph√¢n lo·∫°i...</p>
        </div>
        <div class="relative w-full mb-4 icd-search">
            <div class="flex items-center w-full h-full bg-white">
                <mat-icon class="me-2" [svgIcon]="'heroicons_solid:magnifying-glass'"></mat-icon>
                <input type="text"
                    class="flex-1 border-0 outline-none bg-transparent text-gray-700 text-base placeholder-gray-400"
                    placeholder="Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm..." [(ngModel)]="searchTerm"
                    (ngModelChange)="onSearchChange()" />
                <!-- N√∫t X -->
                <button *ngIf="searchTerm" type="button" (click)="searchTerm=''; suggestions=[]"
                    class="p-1 flex items-center justify-center rounded hover:bg-gray-200 transition">
                    <mat-icon [svgIcon]="'heroicons_outline:x-mark'" class="text-primary"></mat-icon>
                </button>
            </div>
            <!-- üîΩ G·ª¢I √ù T√åM KI·∫æM (dropdown) -->
            <div *ngIf="suggestions.length"
                class="absolute left-0 right-0 mt-1 top-10 bg-white border rounded shadow-lg z-50 max-h-64 overflow-y-auto">

                <div *ngFor="let item of suggestions" class="px-3 py-2 hover:bg-gray-100 cursor-pointer flex gap-2"
                    (click)="selectSuggestion(item)">

                    <!-- <span class="font-semibold text-primary">{{ item.code }}</span>
                    <span>{{ item.title_vi }}</span> -->
                    <!-- highlight code -->
                    <span class="font-semibold text-primary-700" [innerHTML]="highlightMatch(item.code)"></span>

                    <!-- highlight title_vi -->
                    <span [innerHTML]="highlightMatch(item.title_vi)"></span>
                </div>
            </div>
        </div>
        <mat-tree [dataSource]="dataSource" [treeControl]="treeControl" class="icd-tree">
            <!-- Node l√° (kh√¥ng c√≥ con) -->
            <mat-tree-node *matTreeNodeDef="let node" matTreeNodePadding
                [attr.data-code]="node.code"
                [attr.data-chapter]="node.level === 0 ? node.chapter : null"
                [attr.data-level]="node.level"
                [class.selected-node]="isNodeSelected(node)">
                <!-- <button mat-icon-button disabled></button> -->
                <span *ngIf="node.level === 0" (click)="showDetail(node.chapter, node.level)" class="cursor-pointer hover:text-primary-400">
                    {{node.code}}: {{node.title_vi}}
                </span>
                <span *ngIf="node.level !== 0" (click)="showDetail(node.code, node.level)" class="cursor-pointer hover:text-primary-400">
                    {{node.code}}: {{node.title_vi}}
                </span>
            </mat-tree-node>
            <!-- Node c√≥ con (expandable) -->
            <mat-tree-node *matTreeNodeDef="let node; when: hasChild" matTreeNodePadding
                [attr.data-code]="node.code"
                [attr.data-chapter]="node.level === 0 ? node.chapter : null"
                [attr.data-level]="node.level"
                [class.selected-node]="isNodeSelected(node)">
                <button *ngIf="!node.is_leaf" mat-icon-button [matTreeNodeToggle]="node.expandable">
                    <mat-icon>
                        {{treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right'}}
                    </mat-icon>
                </button>
                <button *ngIf="node.is_leaf" mat-icon-button disabled></button>
                <span *ngIf="node.level === 0" (click)="showDetail(node.chapter, node.level)"
                    class="cursor-pointer font-semibold hover:text-primary-400">
                    {{node.chapter}}: {{node.title_vi}}
                </span>
                <span *ngIf="node.level !== 0" (click)="showDetail(node.code, node.level)"
                    class="cursor-pointer font-semibold hover:text-primary-400">
                    {{node.code}}: {{node.title_vi}}
                </span>
            </mat-tree-node>
        </mat-tree>
    </div>

    <!-- RIGHT: Detail -->
    <div class="w-full p-4">
        <div class="detail">
            <ng-container class="relative" *ngIf="selected; else noSel">
                <ng-container *ngIf="selected.chapter">
                    <h2 class="text-2xl text-primary-600 font-bold">
                        CH∆Ø∆†NG {{selected.chapter.chapter}}
                    </h2>
                    <h2 class="text-2xl text-primary-600 font-bold uppercase">
                        {{selected.chapter.title_vi}} ({{selected.chapter.code}})
                    </h2>
                    <p class="mt-3 text-primary-600 text-xl font-semibold">Ch∆∞∆°ng n√†y bao g·ªìm c√°c kh·ªëi sau:</p>
                    <ul class="ml-6">
                        <li *ngFor="let item of selected.children"
                            class="grid grid-cols-[80px_1fr] gap-4 py-2 hover:text-primary-400">
                            <span class="font-semibold cursor-pointer underline" (click)="showDetail(item.code, 1)">{{
                                item.code }}</span>
                            <span>{{ item.title_vi }}</span>
                        </li>
                    </ul>
                </ng-container>
                <ng-container *ngIf="selected.block">
                    <h2 class="text-2xl text-primary-600 font-bold">
                        CH∆Ø∆†NG {{selected.block.chapter.chapter}}
                    </h2>
                    <h2 class="text-2xl text-primary-600 font-bold uppercase">
                        {{selected.block.chapter.title_vi}} ({{selected.block.chapter.code}})
                    </h2>
                    <p class="my-3 pb-2 border-b-2 text-primary-600 text-xl font-semibold">{{selected.block.code}}:
                        {{selected.block.title_vi}}</p>
                    <p class="mt-3 text-primary-600 text-xl font-semibold">Nh√≥m n√†y bao g·ªìm:</p>
                    <ul class="ml-6">
                        <li *ngFor="let item of selected.children"
                            class="grid grid-cols-[50px_1fr] gap-4 py-2 hover:text-primary-400">
                            <span class="font-semibold cursor-pointer underline" (click)="showDetail(item.code, 2)">{{
                                item.code }}</span>
                            <span>{{ item.title_vi }}</span>
                        </li>
                    </ul>
                </ng-container>
                <ng-container *ngIf="selected.disease && !selected.disease_parent">
                    <h2 class="text-2xl text-primary-600 font-bold">
                        CH∆Ø∆†NG {{selected.disease.block.chapter.chapter}}
                    </h2>
                    <h2 class="text-2xl text-primary-600 font-bold uppercase">
                        {{selected.disease.block.chapter.title_vi}} ({{selected.disease.block.chapter.code}})
                    </h2>
                    <p class="my-3 pb-2 border-b-2 text-primary-600 text-xl font-semibold">
                        {{selected.disease.block.code}}: {{selected.disease.block.title_vi}}</p>
                    <p class="my-3 pb-2 border-b-2 text-primary-600 text-lg font-medium">{{selected.disease.code}}:
                        {{selected.disease.title_vi}}</p>
                    <ul class="ml-6">
                        <li *ngFor="let item of selected.children"
                            class="grid grid-cols-[50px_1fr] gap-4 py-2 hover:text-primary-400">
                            <span class="font-semibold cursor-pointer underline" (click)="showDetail(item.code, 3)">{{
                                item.code }}</span>
                            <span>{{ item.title_vi }}</span>
                        </li>
                    </ul>
                </ng-container>
                <ng-container *ngIf="selected.disease_parent">
                    <h2 class="text-2xl text-primary-600 font-bold">
                        CH∆Ø∆†NG {{selected.disease_parent.block.chapter.chapter}}
                    </h2>
                    <h2 class="text-2xl text-primary-600 font-bold uppercase">
                        {{selected.disease_parent.block.chapter.title_vi}}
                        ({{selected.disease_parent.block.chapter.code}})
                    </h2>
                    <p class="my-3 pb-2 border-b-2 text-primary-600 text-xl font-semibold">
                        {{selected.disease_parent.block.code}}: {{selected.disease_parent.block.title_vi}}</p>
                    <p class="my-3 pb-2 border-b-2 text-primary-600 text-lg font-medium">
                        {{selected.disease_parent.code}}: {{selected.disease_parent.title_vi}}</p>
                    <div class="grid grid-cols-[50px_1fr] gap-4 py-2">
                        <span class="font-semibold">{{ selected.disease.code }}</span>
                        <span>{{ selected.disease.title_vi }}</span>
                    </div>
                    <p class="my-3 text-center font-semibold bg-gray-300">C√°c b·ªánh kh√°c c√πng lo·∫°i</p>
                    <ul class="ml-6">
                        <li *ngFor="let item of selected.children" class="grid grid-cols-[50px_1fr] gap-4 py-2">
                            <span class="font-semibold cursor-pointer underline" (click)="showDetail(item.code, 3)">{{
                                item.code }}</span>
                            <span>{{ item.title_vi }}</span>
                        </li>
                    </ul>
                </ng-container>
                <div class="absolute right-6 bottom-6 z-50 group">
                    <button class="w-12 h-12 flex items-center justify-center
                        bg-gray-100 opacity-25 rounded-full p-3 
                        shadow-lg hover:bg-gray-200 hover:opacity-100 transition"
                        (click)="openFeedbackPopup(selected)">
                        <mat-icon class="scale-125" svgIcon="heroicons_solid:chat-bubble-bottom-center-text"></mat-icon>
                    </button>
                    <!-- Tooltip FEEDBACK -->
                    <div class="absolute left-1/2 -translate-x-1/2 bottom-full mb-2
                            bg-gray-700 text-white text-xs px-2 py-1 rounded 
                            opacity-0 group-hover:opacity-100 
                            transition pointer-events-none whitespace-nowrap">
                        G√≥p √Ω
                    </div>
                </div>
            </ng-container>

            <ng-template #noSel>
                <h1 class="font-semibold text-[24px] mb-2">
                    Ph√¢n lo·∫°i qu·ªëc t·∫ø v·ªÅ b·ªánh t·∫≠t v√† c√°c v·∫•n ƒë·ªÅ s·ª©c kh·ªèe li√™n quan ‚Äì Phi√™n b·∫£n l·∫ßn th·ª© 10 (ICD-10)
                </h1>

                <p class="mb-2">
                    B·∫°n c√≥ th·ªÉ duy·ªát h·ªá th·ªëng ph√¢n lo·∫°i b·∫±ng c√°ch s·ª≠ d·ª•ng <strong>c·∫•u tr√∫c ph√¢n c·∫•p ·ªü khung b√™n
                        tr√°i</strong>,
                    ho·∫∑c √°p d·ª•ng <strong>t√≠nh nƒÉng t√¨m ki·∫øm</strong> ƒë·ªÉ nhanh ch√≥ng tra c·ª©u m√£ b·ªánh v√† m√¥ t·∫£ chi ti·∫øt.
                </p>

                <p class="text-gray-500 italic">
                    Th√¥ng tin chi ti·∫øt h∆°n v·ªÅ c√°ch s·ª≠ d·ª•ng tr√¨nh duy·ªát ICD-10 tr·ª±c tuy·∫øn c√≥ s·∫µn trong t√†i li·ªáu h∆∞·ªõng d·∫´n
                    s·ª≠ d·ª•ng.
                </p>
            </ng-template>
        </div>
    </div>
</div>

<div *ngIf="showFeedbackPopup" class="fixed inset-0 bg-black/40 flex items-center justify-center z-[100]">

    <div class="w-[800px] bg-white rounded-lg shadow-lg max-h-[90vh] overflow-hidden">

        <!-- HEADER -->
        <div class="flex items-center justify-between px-4 py-3 bg-primary-600 text-white rounded-t-lg">
            <div class="flex items-center gap-2 text-xl font-semibold">
                <mat-icon svgIcon="heroicons_solid:chat-bubble-bottom-center-text" class="text-white"></mat-icon>
                G√≥p √Ω
            </div>
            <span class="material-icons cursor-pointer hover:text-gray-300" (click)="closeFeedbackPopup()">close</span>
        </div>

        <!-- BODY -->
        <div class="p-5 space-y-4 overflow-y-auto max-h-[70vh]">

            <!-- ============================= -->
            <!--      CASE 1: NOT LOGGED IN    -->
            <!-- ============================= -->
            <div *ngIf="!isLoggedIn" class="text-center py-10">
                <h2 class="text-xl font-semibold mb-3">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p</h2>
                <p class="text-gray-600 mb-5">
                    H√£y ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi g·ª≠i g√≥p √Ω v·ªÅ m√£ b·ªánh ICD-10.
                </p>

                <button (click)="signIn()" class="px-6 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600">
                    ƒêƒÉng nh·∫≠p ngay
                </button>
            </div>

            <!-- ============================= -->
            <!--       CASE 2: LOGGED IN       -->
            <!-- ============================= -->
            <div *ngIf="isLoggedIn">

                <!-- Row 1 -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- Code -->
                    <div>
                        <label class="font-medium flex items-center gap-1 mb-1">
                            <mat-icon svgIcon="heroicons_solid:code-bracket-square"></mat-icon> M√£
                        </label>
                        <input class="w-full border rounded px-3 py-2 mb-3" placeholder="G√≥p √Ω v·ªÅ m√£ b·ªánh"
                            [(ngModel)]="feedBack.code">
                    </div>

                    <!-- Title -->
                    <div>
                        <label class="font-medium flex items-center gap-1 mb-1">
                            <mat-icon svgIcon="heroicons_solid:tag"></mat-icon> Ti√™u ƒë·ªÅ
                        </label>
                        <input class="w-full border rounded px-3 py-2 mb-3" placeholder="G√≥p √Ω v·ªÅ ti√™u ƒë·ªÅ"
                            [(ngModel)]="feedBack.title_vi">
                    </div>
                </div>
                <!-- Chapter -->
                <div *ngIf="feedBack.block && !feedBack.disease" class="relative">
                    <label class="font-medium flex items-center gap-1 mb-1">
                        <mat-icon svgIcon="heroicons_solid:document"></mat-icon> Ch∆∞∆°ng
                    </label>
                    <!-- Dropdown Trigger -->
                    <button type="button"
                        class="text-sm font-semibold px-3 py-2 mb-3 rounded-lg flex items-center gap-1 border w-full"
                        (click)="toggleDropdown(feedBack.id)" [attr.aria-expanded]="isDropdownOpen(feedBack.id)">

                        <!-- Chapter hi·ªán t·∫°i -->
                        {{ (feedBack.new_chapter || feedBack.chapter).chapter }} -
                        {{ (feedBack.new_chapter || feedBack.chapter).title_vi }}
                        ({{ (feedBack.new_chapter || feedBack.chapter).code }})

                        <mat-icon>keyboard_arrow_down</mat-icon>
                    </button>

                    <!-- Dropdown danh s√°ch chapter -->
                    <div *ngIf="isDropdownOpen(feedBack.id)"
                        class="absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 w-full max-h-40 overflow-y-auto">

                        <button *ngFor="let chap of listChapter" type="button"
                            class="w-full px-3 py-2 text-left hover:bg-gray-100 flex items-center gap-2 transition"
                            (click)="selectNewChapter(feedBack, chap)">

                            {{ chap.chapter }} - {{ chap.title_vi }} ({{ chap.code }})

                            <span class="material-icons text-primary ml-auto"
                                *ngIf="feedBack.new_chapter?.id === chap.id">check</span>
                        </button>
                    </div>
                </div>
                <!-- Block -->
                <div *ngIf="feedBack.disease" class="relative">
                    <label class="font-medium flex items-center gap-1 mb-1">
                        <mat-icon svgIcon="heroicons_solid:book-open"></mat-icon> Nh√≥m
                    </label>
                    <!-- Dropdown Trigger -->
                    <button type="button"
                        class="text-sm font-semibold px-3 py-2 mb-3 rounded-lg flex items-center gap-1 border w-full"
                        (click)="toggleDropdown(feedBack.id)" [attr.aria-expanded]="isDropdownOpen(feedBack.id)">

                        <!-- Block hi·ªán t·∫°i -->
                        {{ (feedBack.new_block || feedBack.block).code }} -
                        {{ (feedBack.new_block || feedBack.block).title_vi }}

                        <mat-icon>keyboard_arrow_down</mat-icon>
                    </button>

                    <!-- Dropdown danh s√°ch block -->
                    <div *ngIf="isDropdownOpen(feedBack.id)"
                        class="absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 w-full max-h-40 overflow-y-auto">

                        <button *ngFor="let block of listBlock" type="button"
                            class="w-full px-3 py-2 text-left hover:bg-gray-100 flex items-center gap-2 transition"
                            (click)="selectNewBlock(feedBack, block)">

                            {{ block.code }} - {{ block.title_vi }}

                            <span class="material-icons text-primary ml-auto"
                                *ngIf="feedBack.new_block?.id === block.id">check</span>
                        </button>
                    </div>
                </div>

                <!-- Disease Parent -->
                <div *ngIf="feedBack.disease && feedBack.disease_parent" class="relative">
                    <label class="font-medium flex items-center gap-1 mb-1">
                        <mat-icon svgIcon="heroicons_solid:cube-transparent"></mat-icon> B·ªánh cha
                    </label>
                    <!-- Dropdown Trigger -->
                    <button type="button"
                        class="text-sm font-semibold px-3 py-2 mb-3 rounded-lg flex items-center gap-1 border w-full"
                        (click)="toggleDropdownDiseaseParent(feedBack.id)" [attr.aria-expanded]="isDropdownOpenDiseaseParent(feedBack.id)">

                        <!-- Block hi·ªán t·∫°i -->
                        {{ (feedBack.new_disease_parent || feedBack.disease_parent).code || '-' }} -
                        {{ (feedBack.new_disease_parent || feedBack.disease_parent).title_vi || '-' }}

                        <mat-icon>keyboard_arrow_down</mat-icon>
                    </button>

                    <!-- Dropdown danh s√°ch block -->
                    <div *ngIf="isDropdownOpenDiseaseParent(feedBack.id)"
                        class="absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-50 w-full max-h-40 overflow-y-auto">

                        <button *ngFor="let ds of listDisease" type="button"
                            class="w-full px-3 py-2 text-left hover:bg-gray-100 flex items-center gap-2 transition"
                            (click)="selectNewDiseaseParent(feedBack, ds)">

                            {{ ds.code }} - {{ ds.title_vi }}
                            <span class="material-icons text-primary ml-auto"
                                *ngIf="feedBack.new_disease_parent?.id === ds.id">check</span>
                        </button>
                    </div>
                </div>

                <!-- Reason -->
                <div>
                    <label class="font-medium flex items-center gap-1 mb-1">
                        <mat-icon svgIcon="heroicons_solid:chat-bubble-left-right"></mat-icon> L√Ω do g√≥p √Ω
                    </label>
                    <textarea class="w-full border rounded px-3 py-2 resize-y" rows="4" required
                        placeholder="Nh·∫≠p l√Ω do g√≥p √Ω..." [(ngModel)]="feedBack.reason"></textarea>

                </div>
            </div>

        </div>

        <!-- FOOTER -->
        <div *ngIf="isLoggedIn" class="flex justify-end gap-3 px-6 py-3 bg-gray-100 rounded-b-lg">
            <button class="px-5 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 flex items-center gap-2"
                (click)="closeFeedbackPopup()">
                <mat-icon svgIcon="heroicons_solid:x-mark" class="scale-90"></mat-icon> H·ªßy
            </button>

            <button class="px-5 py-2 bg-primary-400 text-white rounded-lg hover:bg-primary-600 flex items-center gap-2"
                (click)="submitFeedback()">
                <mat-icon svgIcon="heroicons_solid:paper-airplane" class="scale-90 text-white"></mat-icon> G·ª≠i
            </button>
        </div>

    </div>
</div>