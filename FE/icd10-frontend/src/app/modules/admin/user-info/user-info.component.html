<div class="absolute inset-0 z-0 flex flex-col overflow-y-auto fuseScrollbar">

    <!-- Content Wrapper -->
    <div class="p-4 sm:px-6 sm:py-4">

        <!-- Header -->
        <div class="flex max-sm:flex-col max-sm:gap-3 items-center justify-between mb-6">
            <h1 class="text-3xl font-semibold">Thông tin cá nhân</h1>

            <!-- Action Buttons -->
            <div class="flex items-center gap-2 max-sm:self-end">
                <!-- Cancel -->
                <button *ngIf="isEditMode" (click)="toggleEditMode()" class="btn-sub">
                    <mat-icon svgIcon="heroicons_outline:x-circle" class="icon"></mat-icon>
                    <span>Hủy</span>
                </button>

                <!-- Save -->
                <button *ngIf="isEditMode" (click)="saveChanges()" class="btn-primary">
                    <mat-icon svgIcon="heroicons_outline:check-circle" class="icon text-white"></mat-icon>
                    <span>Lưu</span>
                </button>

                <button *ngIf="!isEditMode" (click)="toggleEditMode()"
                    class="px-6 py-2 bg-primary hover:bg-primary-600 text-white rounded-lg">
                    Chỉnh sửa
                </button>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="flex max-sm:flex-col gap-4">

            <!-- Avatar Section -->
            <!-- AVATAR CARD -->
            <div class="bg-white rounded-lg p-6 shadow flex flex-col items-center gap-4">

                <!-- Avatar Preview -->
                <div class="relative">
                    <img [src]="avatarPreviewUrl || user?.avatar || 'assets/images/avatars/default-avatar.svg'"
                        class="object-cover border rounded-full w-48 h-48" />

                    <!-- Icon Upload -->
                    <div class="absolute bottom-1 right-1 cursor-pointer bg-white p-2 rounded-full shadow hover:scale-105 transition"
                        (click)="triggerAvatarEditor()">
                        <img src="assets/icons/icon-upload-image.svg" class="w-6 h-6" />
                    </div>
                </div>

                <!-- Hidden Input -->
                <input #inputAvatar type="file" accept="image/*" class="hidden" (change)="onFileSelected($event)" />

                <!-- Error -->
                <span *ngIf="errorFields['avatar']" class="text-red-500 text-xs mt-1">
                    {{ errorFields["avatar"] }}
                </span>

            </div>


            <!-- USER DETAILS -->
            <div class="flex-1 bg-white rounded-lg shadow p-6">
                <div class="mb-6 flex gap-4">
                    <h3 class="text-xl font-semibold">Thông tin cá nhân</h3>
                    <span [ngClass]="{
                        'bg-blue-100 text-blue-700': role === 2,
                        'bg-yellow-100 text-yellow-600': role !== 2
                        }" class="px-3 py-1 rounded-md text-sm">
                        {{ role === 2 ? 'DOCTOR' : 'USER' }}
                    </span>
                </div>

                <table class="w-full text-left">
                    <tbody>

                        <!-- USERNAME -->
                        <tr class="border-b py-4">
                            <td class="w-1/3 font-medium py-3">Tên đăng nhập <span class="text-red-500">*</span></td>
                            <td>
                                <div *ngIf="!isEditMode">
                                    {{ user?.username }}
                                </div>

                                <div *ngIf="isEditMode" class="flex flex-col gap-2 my-2 py-3">
                                    <input [(ngModel)]="user.username" class="border rounded px-2 py-1 w-full"
                                        placeholder="Tên đăng nhập" required />
                                    <span *ngIf="errorFields['username']" class="text-red-500 text-xs mt-1">
                                        {{ errorFields["username"] }}
                                    </span>
                                </div>
                            </td>
                        </tr>

                        <!-- EMAIL -->
                        <tr class="border-b py-4">
                            <td class="font-medium py-3">Email <span class="text-red-500">*</span></td>
                            <!-- <td>
                                <div *ngIf="!isEditMode">{{ user?.email }}</div>

                                <div *ngIf="isEditMode" class="flex flex-col gap-2 my-2 py-3">
                                    <input [(ngModel)]="user.email" class="border rounded px-2 py-1 w-full"
                                        placeholder="Email" />
                                    <span *ngIf="errorFields['email']" class="text-red-500 text-xs mt-1">
                                        {{ errorFields["email"] }}
                                    </span>
                                </div>
                            </td> -->
                            <td>{{ user?.email }}</td>
                        </tr>

                        <!-- FULL NAME -->
                        <tr class="border-b py-4">
                            <td class="font-medium py-3">Họ và tên</td>
                            <td>
                                <div *ngIf="!isEditMode">
                                    {{ user?.first_name || "---" }} {{ user?.last_name || "---" }}
                                </div>

                                <div *ngIf="isEditMode" class="flex gap-2 my-2 py-3">
                                    <input [(ngModel)]="user.first_name" class="border rounded px-2 py-1 w-1/2"
                                        placeholder="Họ" />
                                    <input [(ngModel)]="user.last_name" class="border rounded px-2 py-1 w-1/2"
                                        placeholder="Tên" />
                                </div>
                            </td>
                        </tr>

                        <!-- VERIFIED DOCTOR STATUS -->
                        <tr *ngIf="verified_doctor" class="border-b py-4">
                            <td class="font-medium py-3">Được phê duyệt</td>
                            <td>
                                <span [ngClass]="{
                                            'bg-green-100 text-green-700': user?.is_verified_doctor,
                                            'bg-red-100 text-red-600': !user?.is_verified_doctor
                                        }" class="px-3 py-1 rounded-full text-sm">
                                    {{ user?.is_verified_doctor ? 'Đã phê duyệt' : 'Chưa phê duyệt' }}
                                </span>
                            </td>
                        </tr>

                        <!-- LICENSE NUMBER -->
                        <tr *ngIf="verified_doctor" class="border-b py-4">
                            <td class="font-medium py-3">Số giấy phép hành nghề</td>
                            <td>{{ user?.license_number }}</td>
                        </tr>

                        <!-- HOSPITAL -->
                        <tr *ngIf="verified_doctor" class="border-b py-4">
                            <td class="font-medium py-3">Nơi công tác</td>
                            <td>{{ user?.hospital }}</td>
                        </tr>

                        <!-- VERIFICATION FILE -->
                        <tr *ngIf="verified_doctor" class="border-b py-4">
                            <td class="font-medium py-3">File xác minh bác sĩ</td>
                            <td class="py-3">
                                <div (click)="openImagePreview()"
                                    class="cursor-pointer">
                                    <img [src]="previewVerification || user?.verification_file"
                                    class="border rounded w-36 h-36 object-cover" />
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- BUTTON VERIFY DOCTOR -->
                <button (click)="opendVerifyPopup()"
                    class="mt-4 px-6 py-2 bg-primary hover:bg-primary-600 text-white rounded-lg">
                    Xác minh bác sĩ
                </button>
            </div>
        </div>
    </div>
</div>

<div *ngIf="verifyPopup" class="fixed inset-0 bg-black/40 flex items-center justify-center z-[100]">

    <div class="w-[800px] bg-white rounded-lg shadow-lg max-h-[90vh] overflow-hidden">

        <!-- HEADER -->
        <div class="flex items-center justify-between px-4 py-3 bg-primary-600 text-white rounded-t-lg">
            <div class="flex items-center gap-2 text-xl font-semibold">
                <mat-icon svgIcon="heroicons_solid:chat-bubble-bottom-center-text" class="text-white"></mat-icon>
                Xác minh bác sĩ
            </div>
            <span class="material-icons cursor-pointer hover:text-gray-300" (click)="closeVerifyPopup()">close</span>
        </div>

        <!-- BODY -->
        <div class="p-5 space-y-4 overflow-y-auto max-h-[70vh]">
            <div>
                <!-- file -->
                <div class="relative py-4">
                    <label class="font-medium flex items-center gap-1 mb-2">
                        <mat-icon svgIcon="heroicons_outline:document-arrow-up"></mat-icon>
                        File xác minh bác sĩ <span class="text-red-500">*</span>
                    </label>

                    <!-- Preview -->
                    <div
                        class="w-36 h-36 border rounded flex items-center justify-center cursor-pointer hover:bg-gray-50"
                        (click)="inputFile.click()"
                    >
                        <ng-container *ngIf="previewVerification; else emptyFile">
                            <img
                                [src]="previewVerification"
                                class="w-full h-full object-cover rounded"
                            />
                        </ng-container>

                        <ng-template #emptyFile>
                            <span class="text-gray-400 text-sm text-center px-2">
                                Click để tải file<br>(Ảnh)
                            </span>
                        </ng-template>
                    </div>

                    <input
                        #inputFile
                        type="file"
                        accept="image/*"
                        hidden
                        (change)="onVerificationFileSelected($event)"
                    />

                    <!-- Error -->
                    <span *ngIf="errorFields['file']" class="text-red-500 text-xs mt-1">
                        {{ errorFields["file"] }}
                    </span>
                </div>

                <!-- license_number -->
                <div class="py-4">
                    <label class="font-medium flex items-center gap-1 mb-1">
                        <mat-icon svgIcon="heroicons_outline:code-bracket"></mat-icon> Số giấy phép hành nghề <span class="text-red-500">*</span>
                    </label>
                    <input class="w-full border rounded px-3 py-2 mb-3" placeholder="Nhập số giấy phép hành nghề..."
                        [(ngModel)]="licenseNumber">
                </div>

                <!-- Bệnh viện -->
                <div class="py-4">
                    <label class="font-medium flex items-center gap-1 mb-1">
                        <mat-icon svgIcon="heroicons_outline:home-modern"></mat-icon> Nơi công tác <span class="text-red-500">*</span>
                    </label>
                    <input class="w-full border rounded px-3 py-2 mb-3" placeholder="Nhập nơi công tác..."
                        [(ngModel)]="hospitalName">
                </div>
            </div>

        </div>

        <!-- FOOTER -->
        <div class="flex justify-end gap-3 px-6 py-3 bg-gray-100 rounded-b-lg">
            <button class="px-5 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 flex items-center gap-2"
                (click)="closeVerifyPopup()">
                <mat-icon svgIcon="heroicons_solid:x-mark" class="scale-90"></mat-icon> Hủy
            </button>

            <button class="px-5 py-2 bg-primary-400 text-white rounded-lg hover:bg-primary-600 flex items-center gap-2"
                (click)="verifyDoctor($event)">
                <mat-icon svgIcon="heroicons_solid:paper-airplane" class="scale-90 text-white"></mat-icon> Gửi
            </button>
        </div>

    </div>
</div>

<div *ngIf="popupEmail" class="fixed inset-0 bg-black/40 flex items-center justify-center z-[100]">

    <div class="w-[800px] bg-white rounded-lg shadow-lg max-h-[90vh] overflow-hidden">

        <!-- HEADER -->
        <div class="flex items-center justify-between px-4 py-3 bg-primary-600 text-white rounded-t-lg">
            <div class="flex items-center gap-2 text-xl font-semibold">
                <mat-icon svgIcon="heroicons_solid:chat-bubble-bottom-center-text" class="text-white"></mat-icon>
                Thông báo
            </div>
            <span class="material-icons cursor-pointer hover:text-gray-300" (click)="closePopUpEmail()">close</span>
        </div>

        <!-- BODY -->
        <div class="p-5 space-y-4 overflow-y-auto max-h-[70vh]">
            <div *ngIf="!isLoggedIn" class="text-center py-10">
                <h2 class="text-xl font-semibold mb-3">Bạn muốn thay đổi email?</h2>
                <p class="text-gray-600 mb-5">
                    Khi thay đổi email. Hệ thống sẽ gửi link xác thực qua email của bạn. Link có hiệu lực trong 2 phút.
                    Hãy xác nhận lại. 
                </p>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="flex justify-end gap-3 px-6 py-3 bg-gray-100 rounded-b-lg">
            <button class="px-5 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 flex items-center gap-2"
                (click)="closePopUpEmail()">
                <mat-icon svgIcon="heroicons_outline:x-mark" class="scale-90"></mat-icon> Hủy
            </button>

            <button class="px-5 py-2 bg-primary-400 text-white rounded-lg hover:bg-primary-600 flex items-center gap-2"
                (click)="confirmEmail()">
                <mat-icon svgIcon="heroicons_outline:paper-airplane" class="scale-90 text-white"></mat-icon> Đồng ý
            </button>
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div
    *ngIf="popupPreview"
    class="fixed inset-0 z-[9999] bg-black/80 flex items-center justify-center"
>
    <!-- Close button -->
    <button
        class="absolute top-6 right-8 text-white text-4xl leading-none hover:text-gray-300"
        (click)="closeImagePreview()"
        aria-label="Close"
    >
        &times;
    </button>

    <!-- Image -->
    <img
        [src]="previewVerification || user?.verification_file"
        class="max-w-[90vw] max-h-[90vh] object-contain cursor-zoom-out"
        (click)="closeImagePreview()"
        alt="Preview image"
    />
</div>