<!-- ...existing code... -->
<div class="bg-white space-y-4 h-[calc(100vh-70px)] w-full overflow-y-auto">
    <div class="flex items-center justify-between mb-3 p-3">
        <h2 class="text-2xl font-semibold">Góp ý của tôi</h2>
    </div>
    <!-- Tabs -->
    <mat-tab-group
        class="sm:px-2"
        mat-stretch-tabs="false"
        [animationDuration]="'0'">
        <mat-tab>
            <ng-template mat-tab-label>
                <span class="inline-flex items-center space-x-2">
                    <span class="">Chương</span>
                    <span class="px-2 py-1 text-sm rounded-full bg-primary-50 text-on-primary-100">{{ feedbackChapter.length }}</span>
                </span>
            </ng-template>
            <ng-template matTabContent>
                <section *ngIf="feedbackChapter?.length; else noChapter">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4">
                        <div *ngFor="let item of feedbackChapter; trackBy: trackById"
                            class="bg-[#e8eaebff] border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-all duration-150">
                            <div class="flex gap-4 items-start justify-between">
                                <div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-lg font-bold text-primary">{{ item.code || item.chapter?.code || '—'
                                            }}</span>
                                        <div class="text-sm text-primary-600">{{ item.title_vi || item.chapter?.title_vi || 'Không có
                                            tiêu đề' }}</div>
                                    </div>
                                    <div class="text-xs text-primary-600 mt-1">{{ item.created_at | date:'dd/MM/yyyy HH:mm' }}</div>
                                </div>

                                <div class="text-right">
                                    <div [ngClass]="statusClass(item.status)"
                                        class="px-3 py-1.5 text-xs font-semibold rounded-full whitespace-nowrap">
                                        {{ statusLabel(item.status) }}
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3 bg-gray-50 p-3 rounded-lg border text-gray-700 text-sm">
                                <span class="font-semibold text-gray-600">Lý do:</span>
                                <span class="ml-1">{{ item.reason || '—' }}</span>
                            </div>

                            <div class="mt-3 flex justify-end gap-2">
                                <!-- điều hướng nếu muốn: routerLink cần được xử lý trong component -->
                                <button mat-button class="text-sm text-primary" (click)="openDetailICD(item, 'chapter')">Xem</button>
                            </div>
                        </div>
                    </div>
                </section>
                <ng-template #noChapter>
                    <div class="text-sm text-gray-500 italic">Chưa có góp ý cho Chương.</div>
                </ng-template>
            </ng-template>
        </mat-tab>
        <mat-tab>
            <ng-template mat-tab-label>
                <span class="inline-flex items-center space-x-2">
                    <span class="">Nhóm</span>
                    <span class="px-2 py-1 text-sm rounded-full bg-primary-50 text-on-primary-100">{{ feedbackBlock.length }}</span>
                </span>
            </ng-template>
            <ng-template matTabContent>
                <section *ngIf="feedbackBlock?.length; else noBlock">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4">
                        <div *ngFor="let item of feedbackBlock; trackBy: trackById"
                            class="bg-[#e8eaebff] border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-all duration-150">
                            <div class="flex items-start justify-between">
                                <div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-lg font-bold text-primary">{{ item.code || item.block?.code || '—'
                                            }}</span>
                                        <div class="text-sm text-primary-600">{{ item.title_vi || item.block?.title_vi || 'Không có
                                            tiêu đề' }}</div>
                                    </div>
                                    <div class="text-xs text-primary-600 mt-1">{{ item.created_at | date:'dd/MM/yyyy HH:mm' }}</div>
                                    <div *ngIf="item.chapter || item.block?.chapter" class="text-xs text-primary-600 mt-1">
                                        Thuộc chương: {{ item.chapter?.chapter }} - {{ item.chapter?.title_vi }} {{ (item.chapter?.code) }}
                                    </div>
                                </div>

                                <div class="text-right">
                                    <div [ngClass]="statusClass(item.status)"
                                        class="px-3 py-1.5 text-xs font-semibold rounded-full whitespace-nowrap">
                                        {{ statusLabel(item.status) }}
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3 bg-gray-50 p-3 rounded-lg border text-gray-700 text-sm">
                                <span class="font-semibold text-gray-600">Lý do:</span>
                                <span class="ml-1">{{ item.reason || '—' }}</span>
                            </div>

                            <div class="mt-3 flex justify-end gap-2">
                                <button mat-button class="text-sm text-primary" (click)="openDetailICD(item, 'block')">Xem</button>
                            </div>
                        </div>
                    </div>
                </section>
                <ng-template #noBlock>
                    <div class="text-sm text-gray-500 italic">Chưa có góp ý cho Nhóm.</div>
                </ng-template>
            </ng-template>
        </mat-tab>
        <mat-tab>
            <ng-template mat-tab-label>
                <span class="inline-flex items-center space-x-2">
                    <span class="">Mã bệnh</span>
                    <span class="px-2 py-1 text-sm rounded-full bg-primary-50 text-on-primary-100">{{ feedbackDisease.length }}</span>
                </span>
            </ng-template>
            <ng-template matTabContent>
                <section *ngIf="feedbackDisease?.length; else noDisease">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4">
                        <div *ngFor="let item of feedbackDisease; trackBy: trackById"
                            class="bg-[#e8eaebff] border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-all duration-150">
                            <div class="flex items-start justify-between">
                                <div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-lg font-bold text-primary">{{ item.code || item.disease?.code || '—'
                                            }}</span>
                                        <div class="text-sm text-primary-600">{{ item.title_vi || item.disease?.title_vi || 'Không có
                                            tiêu đề' }}</div>
                                    </div>
                                    <div class="text-xs text-primary-600 mt-1">{{ item.created_at | date:'dd/MM/yyyy HH:mm' }}</div>
                                    <div *ngIf="item.block || item.disease?.block" class="text-xs text-primary-600 mt-1">
                                        Thuộc nhóm: {{ item.block?.code }} - {{ item.block?.title_vi }}
                                    </div>
                                    <div *ngIf="item.disease_parent" class="text-xs text-primary-600 mt-1">
                                        Bệnh cha: {{ item.disease_parent?.code }} - {{ item.disease_parent?.title_vi }}
                                    </div>
                                </div>

                                <div class="text-right">
                                    <div [ngClass]="statusClass(item.status)"
                                        class="px-3 py-1.5 text-xs font-semibold rounded-full whitespace-nowrap">
                                        {{ statusLabel(item.status) }}
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3 bg-gray-50 p-3 rounded-lg border text-gray-700 text-sm">
                                <span class="font-semibold text-gray-600">Lý do:</span>
                                <span class="ml-1">{{ item.reason || '—' }}</span>
                            </div>

                            <div class="mt-3 flex justify-end gap-2">
                                <button mat-button class="text-sm text-primary" (click)="openDetailICD(item, 'disease')">Xem</button>
                            </div>
                        </div>
                    </div>
                </section>
                <ng-template #noDisease>
                    <div class="text-sm text-gray-500 italic">Chưa có góp ý cho Mã bệnh.</div>
                </ng-template>
            </ng-template>
        </mat-tab>
        <mat-tab>
            <ng-template mat-tab-label>
                <span class="inline-flex items-center space-x-2">
                    <span class="">Chatbot</span>
                    <span class="px-2 py-1 text-sm rounded-full bg-primary-50 text-on-primary-100">{{ feedbackChatbot.length }}</span>
                </span>
            </ng-template>
            <ng-template matTabContent>
                <section *ngIf="feedbackChatbot?.length; else noChatbot">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4">
                        <div *ngFor="let item of feedbackChatbot; trackBy: trackById"
                            class="bg-[#e8eaebff] border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-all duration-150">
                            <div class="flex items-start justify-between">
                                <div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-lg font-bold text-primary">{{ item.session?.title || '—'
                                            }}
                                        </span>
                                    </div>
                                    <div class="text-xs text-primary-600 mt-1">{{ item.created_at | date:'dd/MM/yyyy HH:mm' }}</div>
                                    <div class="flex items-center space-x-1">
                                        <ng-container *ngFor="let star of [1,2,3,4,5]">
                                            <mat-icon 
                                                class="w-4 h-4"
                                                [ngClass]="star <= item.rating ? 'text-yellow-500' : 'text-gray-300'"
                                                [svgIcon]="'heroicons_solid:star'">
                                            </mat-icon>
                                        </ng-container>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div [ngClass]="statusClass(item.status)"
                                        class="px-3 py-1.5 text-xs font-semibold rounded-full whitespace-nowrap">
                                        {{ statusLabel(item.status) }}
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3 bg-gray-50 p-3 rounded-lg border text-gray-700 text-sm">
                                <span class="font-semibold text-gray-600">Bình luận:</span>
                                <span class="ml-1">{{ item.comments || '—' }}</span>
                            </div>

                            <div class="mt-3 bg-gray-50 p-3 rounded-lg border text-gray-700 text-sm">
                                <span class="font-semibold text-gray-600">Tin nhắn:</span>
                                <span class="ml-1" [innerHTML]="getContentHtml(item)"></span>
                            </div>

                            <div class="mt-3 flex justify-end gap-2">
                                <button mat-button class="text-sm text-primary" (click)="openDetailChatbot(item)">Xem</button>
                            </div>
                        </div>
                    </div>
                </section>
                <ng-template #noChatbot>
                    <div class="text-sm text-gray-500 italic">Chưa có góp ý cho Chatbot.</div>
                </ng-template>
            </ng-template>
        </mat-tab>
    </mat-tab-group>
</div>

<div *ngIf="showDetailICDPopup" class="fixed inset-0 bg-black/40 flex items-center justify-center z-[100]">
    <div class="w-[720px] bg-white rounded-lg shadow-lg max-h-[80vh] overflow-auto">
        <div class="flex items-center justify-between px-4 py-3 bg-primary-600 text-white rounded-t-lg">
            <div class="flex items-center gap-2 text-lg font-semibold">
                <mat-icon svgIcon="heroicons_solid:information-circle" class="text-white"></mat-icon>
                Chi tiết góp ý
            </div>
            <span class="material-icons cursor-pointer hover:text-gray-300" (click)="closeDetailPopup()">close</span>
        </div>

        <div class="p-5 space-y-3">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <div class="text-xs text-gray-500">Loại góp ý</div>
                    <div class="font-medium">{{ detailType | titlecase }}</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Mã</div>
                    <div class="font-medium">{{ detailItem?.code || detailItem?.chapter?.code || detailItem?.block?.code || detailItem?.disease?.code }}</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Trạng thái</div>
                    <div [ngClass]="statusClass(detailItem?.status)" class="inline-block px-2 py-1 rounded text-sm">
                        {{ statusLabel(detailItem?.status) }}
                    </div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Tiêu đề</div>
                    <div class="font-medium">{{ detailItem?.title_vi || detailItem?.chapter?.title_vi || detailItem?.block?.title_vi || detailItem?.disease?.title_vi }}</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Ngày tạo</div>
                    <div class="font-medium">{{ detailItem?.created_at | date:'dd/MM/yyyy HH:mm' }}</div>
                </div>
            </div>

            <!-- show related info -->
            <div *ngIf="detailType === 'block' && (detailItem?.chapter || detailItem?.block?.chapter)">
                <div class="text-xs text-gray-500">Thuộc chương</div>
                <div class="mt-1">{{ detailItem?.chapter?.chapter }} - {{ detailItem?.chapter?.title_vi }} {{ (detailItem?.chapter?.code) }}</div>
            </div>

            <div *ngIf="detailType === 'disease'">
                <div class="text-xs text-gray-500">Thuộc nhóm</div>
                <div class="mt-1">{{ detailItem?.block?.code }} - {{ detailItem?.block?.title_vi }}</div>

                <div *ngIf="detailItem?.disease?.disease_parent || detailItem?.disease_parent" class="mt-2">
                    <div class="text-xs text-gray-500">Bệnh cha</div>
                    <div class="mt-1">{{ detailItem?.disease_parent?.code }} - {{ detailItem?.disease_parent?.title_vi }}</div>
                </div>
            </div>
            <div>
                <div class="text-xs text-gray-500">Lý do</div>
                <div class="mt-1 p-3 bg-gray-50 rounded">{{ detailItem?.reason || '—' }}</div>
            </div>
        </div>

        <div class="flex justify-end gap-3 px-4 py-3 bg-gray-100 rounded-b-lg">
            <button class="px-4 py-2 bg-gray-200 rounded" (click)="closeDetailPopup()">Đóng</button>
            <button class="px-4 py-2 bg-primary-500 text-white rounded" (click)="viewInICD()">Xem trên ICD</button>
        </div>
    </div>
</div>

<div *ngIf="showDetailChatbotPopup" class="fixed inset-0 bg-black/40 flex items-center justify-center z-[200]">
    <div class="w-[650px] bg-white rounded-lg shadow-lg max-h-[85vh]">
        <!-- Header -->
        <div class="flex items-center justify-between px-4 py-3 bg-primary-600 text-white rounded-t-lg">
            <div class="flex items-center gap-2 text-lg font-semibold">
                <mat-icon svgIcon="heroicons_solid:chat-bubble-left-right" class="text-white"></mat-icon>
                Chi tiết góp ý Chatbot
            </div>
            <button (click)="closeDetailChatbot()">
                <mat-icon class="cursor-pointer text-white">close</mat-icon>
            </button>
        </div>

        <!-- Nội dung -->
        <div class="p-5 space-y-4 max-h-[70vh] overflow-auto">
            <!-- Session -->
            <div class="p-3 bg-primary-50 border rounded-lg">
                <div class="text-sm font-medium text-primary-800">
                    Phiên chat: {{ detailItem?.session?.title || "—" }}
                </div>
                <div class="text-xs text-primary mt-1">
                    {{ detailItem?.created_at | date:'dd/MM/yyyy HH:mm' }}
                </div>
            </div>

            <!-- Rating -->
            <div>
                <label class="font-semibold text-gray-700">Đánh giá:</label>
                <div class="flex items-center mt-1 gap-1">
                    <ng-container *ngFor="let star of [1,2,3,4,5]">
                        <mat-icon
                            class="text-2xl"
                            [ngClass]="star <= detailItem.rating ? 'text-yellow-500' : 'text-gray-300'"
                            svgIcon="heroicons_solid:star">
                        </mat-icon>
                    </ng-container>
                </div>
            </div>

            <!-- Comment -->
            <div class="bg-gray-50 p-3 rounded-lg border text-gray-700 text-sm">
                <span class="font-semibold text-gray-600">Bình luận:</span>
                <p class="mt-1 whitespace-pre-line">
                    {{ detailItem?.comments || 'Không có bình luận.' }}
                </p>
            </div>

            <!-- Message content -->
            <div>
                <span class="font-semibold text-gray-600">Tin nhắn gốc:</span>
                <div class="border bg-gray-50 p-3 rounded-lg mt-2">
                    <div class="flex items-start gap-3">
                        <mat-icon class="text-gray-500" [svgIcon]="'heroicons_outline:cpu-chip'"></mat-icon>
                        <div class="flex-1 text-sm leading-relaxed"
                             [innerHTML]="getContentHtml(detailItem, true)">
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Footer -->
        <div class="flex justify-end gap-3 px-4 py-3 bg-gray-100 rounded-b-lg">
            <button class="px-4 py-2 bg-gray-200 rounded" (click)="closeDetailChatbot()">Đóng</button>
            <button class="px-4 py-2 bg-primary-500 text-white rounded" (click)="viewChat()">Xem phiên chat</button>
        </div>

    </div>

</div>
